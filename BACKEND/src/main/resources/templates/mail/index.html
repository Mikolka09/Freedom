<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:insert="/user/fragments/head.html::head"></th:block>

<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">

    <!-- Sidebar -->
    <th:block th:insert="/user/fragments/sidebar.html::sidebar"></th:block>
    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

        <!-- Main Content -->
        <div id="content">
            <th:block th:insert="/user/fragments/topbar.html::topbar"></th:block>


            <!-- Begin Page Content -->
            <div class="col-md-12 col-md-offset-1">
                <h1 class="text-center">List Messages</h1>

                <th:block th:if="${messageList.size()!=0}"
                          th:insert="/mail/mail-list-group.html::mail-list-group"></th:block>

            </div>
            <!-- /.container-fluid -->

        </div>
        <!-- End of Main Content -->

        <!-- Footer -->
        <th:block th:insert="/user/fragments/footer.html::footer"></th:block>
        <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>

<!-- Logout Modal-->
<th:block th:insert="/user/fragments/logout-modal.html::logout-modal"></th:block>
<th:block th:insert="/user/fragments/delete-modal.html::delete-modal"></th:block>
<th:block th:insert="/user/fragments/delete-user-modal.html::delete-user-modal"></th:block>
<th:block th:insert="/user/fragments/alert-modal.html::alert-modal"></th:block>
<th:block th:insert="/user/fragments/message-modal.html::message-modal"></th:block>
<th:block th:insert="/user/fragments/send-user-massege.html::send-user-message"></th:block>

<th:block th:insert="/user/fragments/user-other-foot.html::user-other-foot"></th:block>

<script>

    $('.open-all-messages').on('click', function (event) {
        let id = $(this).attr('data-id');
        if (typeof id != "undefined") {
            $.get({
                url: "/user/messages/all-messages/" + id,
                success: (data) => {
                    printAllUserMessages(data);
                },
                error: (err) => {
                    console.log(err);
                }
            });
        }
    });

    /*function changeColor(){
        let arr = document.querySelectorAll("li.list-group-item")
        for ()
    }*/

    function printAllUserMessages(data) {
        if (data != null) {
            document.getElementById('name-user-from').innerText = data[0].invite.userFrom.fullName;

            let container = document.getElementById('container-messages');
            container.innerHTML = "";
            for (let i = 0; i < data.length; i++) {
                let li = document.createElement('li');
                li.className = "list-group-item";
                li.style.fontWeight = data[i].invite.status === "VIEWED" ? "normal" : "bold";
                let div1 = document.createElement('div');
                div1.className = "row";
                let div2 = document.createElement('div');
                div2.className = "col-11";
                let div3 = document.createElement('div');
                div3.className = "col text-right";
                let span1 = document.createElement('span');
                span1.className = "badge rounded-pill " + ((data[i].invite.status==="NOT_VIEWED"||
                    data[i].invite.status==="REQUEST")?"badge-warning":"badge-success");
                span1.innerText = data[i].invite.status==="REQUEST"?"NOT_VIEWED":data[i].invite.status;
                div3.appendChild(span1);
                div2.appendChild(div3);
                let p1 = document.createElement('p');
                p1.className = "mb-2";
                p1.style.color = "#6a1a21";
                p1.style.textDecorationLine = "underline";
                p1.innerText = correctDate(data[i].createdAt);
                div2.appendChild(p1);
                let p2 = document.createElement('p');
                p2.className = "mb-0 text-dark";
                p2.innerText = data[i].message.length>200?(data[i].message.substring(0,200)+" ..."):data[i].message;
                div2.appendChild(p2);
                div1.appendChild(div2);
                let div4 = document.createElement('div');
                div4.className = "col-1 align-self-center";
                let div5 = document.createElement('div');
                div5.title = "Read";
                let a1 = document.createElement('a');
                a1.href = "#";
                a1.id = "readMessage";
                a1.dataset.target = "#MessageModal";
                a1.dataset.toggle = "modal";
                a1.dataset.dies = data[i].invite.status==="VIEWED";
                a1.dataset.id = data[i].id;
                a1.dataset.idFrom = data[i].invite.userFrom.id;
                a1.dataset.idTo = data[i].invite.userTo.id;
                a1.dataset.name = data[i].invite.userFrom.fullName;
                a1.dataset.text = data[i].message;
                a1.dataset.date = correctDate(data[i].createdAt);
                let img1 = document.createElement('img');
                img1.src = "/img/icon/read.png";
                img1.width = 30;
                a1.appendChild(img1);
                div5.appendChild(a1);
                div4.appendChild(div5);
                let div6 = document.createElement('div');
                div6.style.paddingTop = "15px";
                div6.title = "Answer";
                let a2 = document.createElement('a');
                a2.href = "#";
                a2.className = "answerMessage";
                a2.dataset.id = data[i].id;
                a2.dataset.idFrom = data[i].invite.userFrom.id;
                a2.dataset.idTo = data[i].invite.userTo.id;
                a2.dataset.name = data[i].invite.userFrom.fullName;
                let img2 = document.createElement('img');
                img2.src = "/img/icon/answer.png";
                img2.width = 30;
                a2.appendChild(img2);
                div6.appendChild(a2);
                div4.appendChild(div6);
                div1.appendChild(div4);
                li.appendChild(div1);
                container.appendChild(li);
            }
        }
    }

    function correctDate(date) {
        let data = new Date(date.toString());
        return data.toLocaleDateString('en-GB', {
            day: 'numeric', month: 'long', year: 'numeric'
        }).replace(/ /g, ' ');
    }

</script>

</body>

</html>